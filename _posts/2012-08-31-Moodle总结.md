---
layout: post
title: Moodle总结
category: community
---

这几日忙里偸闲，在图灵社区翻译了Architecture of Open Source Applications第二卷[Moodle](http://www.ituring.com.cn/article/9966)一章。这算是我第一次做技术翻译，三天翻译完成之后又经过了一次大的修改，或许工作仍有疏漏，还请各位指正。lt在回帖中提到希望有一个1000字左右的简介，在修订完后我觉得还是必要的。因此我先谈一下我对这篇文章的看法，然后对我认为更有价值的内容再进行提炼浓缩。

我的看法
--------
就像AOSA书名提到的，这本书讨论的是软件的架构（其实我更喜欢他们提到的整个软件开发的原因和历程）。所以接触这本书的大部分应该是稍有经验的开发者或者架构师。但是Tim这里介绍的过于详细，有点User Manual或者Developer Guide的味道。许多例子（比如建立统一入口，以及国际化），实际上已经众所皆知了，完全可以提一句然后让不太明白的读者自己去搜寻。他一个贯穿全文的例子，对于每一行都进行了详尽的解释，然后再拉出与之相关的各种历史。整篇文章翻译完17 000多字，字里行间透露着作者像看待Moodle如孩子一样的细致的感情。我认为这篇文章更重要的或许是间杂其中，作者点滴回忆的Moodle设计历史。从这些设计逐渐的进化中，我们才能够更加看清一个好的设计需要为每一个阶段变更的需求进行调整。但是每一次设计，就像作者最后提到的，要做到恰到好处，既不会过于简单而至于不能满足需求，更不要过于复杂使得难以维护。所以我相信，如果你愿意把原版文章（= =或者我翻译的这个）读完，得到的收获绝对要比下面的总结要大的多。

文章的总结
---------
这篇文章作者通过设计一个简单的"Hello World“插件，来简要说明了在Moodle中四个他认为比较精彩的设计，分别是

1. 插件化方法  
2. 权限系统  
3. 渲染过程  
4. 独立的数据库抽象层

###插件化
一开始，作者先提到Moodle的三部分：放在Web目录下的代码，数据库，和一个存储用户上传文件的目录。而后，他指出Moodle支持两种route方式：  

1. 直接访问脚本，只不过在每个请求的脚本最开始要调require一下`config.php` （这个文件加载所有Moodle标准库、处理会话、连接数据库并且初始化全局变量）
2. 创建统一入口（通常这需要在这个目录下进行rewrite）

Moodle本身是插件化的，但是由于历史的原因，它的内核十分庞大，提供了许多额外的功能（其实他们现在一直在努力将内核的功能转移到插件中去，但是特性集的逐渐膨胀使得重构和满足新的功能之间需要调和，所以进展不大）。插件放在一个`类型/插件名`的目录里面，里面要包含`version.php`（插件元数据）和`index.php`（插件的主要行为）等等。

这里面作者提到了两种插件化的方法：一种是说整个项目由一个插件启动器启动（通常负责处理依赖以及初始化等等），其他的部分交由插件自己完成（包括插件之间的交互）。另一种是说提供内核提供一个事件引擎，插件通过注册事件和钩子函数来交互以完成功能。感兴趣的读者可以深入的去查一下，这在事件驱动的框架里面都很常见。

###权限系统
Moodle作为一个教学系统，用户和角色必须被严格的区分。一个角色通俗的来说就是一个group（组），而权限系统的任何权限是相对与角色而言的。

要说明白它的权限系统，就要先说它的Context（译文中我翻译成上下文，其实我感觉不用翻译，翻译出来自己都觉得别扭）。context可以认为是用户当前所处的环境，所以它存储了关于这个环境的信息。系统有一个根context，进入到一个插件，或者子模块中，与之对应的context也会加入进来产生作用。所以整个context系统是一个树形结构，有点像某某老喜欢提的备忘录模式。两个context的有相同的环境变量，那么在儿子context中时，儿子的环境变量覆盖祖先的。context之所以关键，因为它记录了当前登录的这个用户在当前context里面都扮演了什么角色。

一个能力实际上就是一个用户可能采取的行为，比如发帖子，打酱油（这里面是打招呼）。每个插件里有一个`access.php`文件来定义能力。

现在定义权限。权限是说一个角色能不能干一个能力，这些权限被记录在context里。`能不能干`分四种：

1. UNSET/INHERIT，不知道，所以我爹能干我就能干  
2. ALLOW，能干  
3. PREVENT，不能干  
4. PROHIBIT，就是不能干，还不能让我的儿子们干  

最后当前用户到底能不能打酱油，是这么计算出来的：

1. 要是我现在有任何一个角色是“就是不能干”，我就不能打  
2. 否则，有任何一个角色说“能干”，我就能打
3. 还是过了2还没有，那我就不能打

(未完待续...)
